{
  "hash": "58b8846482d5d875cfe546939cef2d3e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Lab Assignment 4: Spatial Predictive Analysis\"\nsubtitle: \"Spatial Predictive Analysis of Vacant and Abandoned Buildings\"\nauthor: \"Ye Zhang\"\ndate: \"2025-11-16\"\nformat:\n  html:\n    code-fold: show\n    code-tools: true\n    toc: true\n    toc-depth: 3\n    toc-location: left\n    theme: cosmo\n    embed-resources: true\neditor: visual\nexecute:\n  warning: false\n  message: false\n---\n\n## Introduction\n\nIn this analysis, I will build a spatial predictive model for vacant and abandoned buildings in Chicago. Abandoned buildings are a critical urban issue that affects neighborhood stability, property values, public safety, and community well-being. By analyzing the spatial patterns of reported vacant and abandoned buildings, we can better understand where these issues concentrate and potentially improve city intervention strategies.\n\n# Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(tidyverse)      # Data manipulation\nlibrary(sf)             # Spatial operations\nlibrary(here)           # Relative file paths\nlibrary(viridis)        # Color scales\nlibrary(spdep)          # Spatial dependence\nlibrary(FNN)            # Fast nearest neighbors\nlibrary(MASS)           # Negative binomial regression\nlibrary(patchwork)      # Plot composition\nlibrary(knitr)          # Tables\nlibrary(kableExtra)     # Table formatting\nlibrary(spatstat.geom)    # Spatial geometries\nlibrary(spatstat.explore) # Spatial exploration/KDE\nlibrary(lubridate)      # Date handling\nlibrary(terra)          # Raster operations\n\n# Set options\noptions(scipen = 999)  # No scientific notation\nset.seed(5080)         # Reproducibility\n\n# Create consistent theme for visualizations\ntheme_buildings <- function(base_size = 11) {\n  theme_minimal(base_size = base_size) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = base_size + 1),\n      plot.subtitle = element_text(color = \"gray30\", size = base_size - 1),\n      legend.position = \"right\",\n      panel.grid.minor = element_blank(),\n      axis.text = element_blank(),\n      axis.title = element_blank()\n    )\n}\n\n# Set as default\ntheme_set(theme_buildings())\n\ncat(\"✓ All packages loaded successfully!\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ All packages loaded successfully!\n```\n\n\n:::\n:::\n\n\n# Part 1: Data Loading & Exploration\n\n## Load Chicago Spatial Boundaries\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load police districts - we'll use these for cross-validation later\npoliceDistricts <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON\") %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(District = dist_num)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `OGRGeoJSON' from data source \n  `https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON' \n  using driver `GeoJSON'\nSimple feature collection with 25 features and 2 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -87.94011 ymin: 41.64455 xmax: -87.52414 ymax: 42.02303\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\n# Load police beats - smaller units within districts\npoliceBeats <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/n9it-hstw?method=export&format=GeoJSON\") %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(Beat = beat_num)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `OGRGeoJSON' from data source \n  `https://data.cityofchicago.org/api/geospatial/n9it-hstw?method=export&format=GeoJSON' \n  using driver `GeoJSON'\nSimple feature collection with 277 features and 4 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -87.94011 ymin: 41.64455 xmax: -87.52414 ymax: 42.02303\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\n# Load Chicago boundary - the city outline\nchicagoBoundary <- \n  st_read(\"https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson\") %>%\n  st_transform('ESRI:102271')\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `chicagoBoundary' from data source \n  `https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 1 feature and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -87.8367 ymin: 41.64454 xmax: -87.52414 ymax: 42.02304\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"✓ Loaded spatial boundaries\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Loaded spatial boundaries\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Police districts:\", nrow(policeDistricts), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Police districts: 25 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Police beats:\", nrow(policeBeats), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Police beats: 277 \n```\n\n\n:::\n:::\n\n\n## Load Vacant and Abandoned Buildings Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbuilding_raw <- read_csv(here(\"data\", \"311_Service_Requests_-_Vacant_and_Abandoned_Buildings_Reported_-_Historical_20251116.csv\"))\n\n\ncat(\"Column names in dataset:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nColumn names in dataset:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(names(building_raw))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"SERVICE REQUEST TYPE\"                                                 \n [2] \"SERVICE REQUEST NUMBER\"                                               \n [3] \"DATE SERVICE REQUEST WAS RECEIVED\"                                    \n [4] \"LOCATION OF BUILDING ON THE LOT (IF GARAGE, CHANGE TYPE CODE TO BGD).\"\n [5] \"IS THE BUILDING DANGEROUS OR HAZARDOUS?\"                              \n [6] \"IS BUILDING OPEN OR BOARDED?\"                                         \n [7] \"IF THE BUILDING IS OPEN, WHERE IS THE ENTRY POINT?\"                   \n [8] \"IS THE BUILDING CURRENTLY VACANT OR OCCUPIED?\"                        \n [9] \"IS THE BUILDING VACANT DUE TO FIRE?\"                                  \n[10] \"ANY PEOPLE USING PROPERTY? (HOMELESS, CHILDEN, GANGS)\"                \n[11] \"ADDRESS STREET NUMBER\"                                                \n[12] \"ADDRESS STREET DIRECTION\"                                             \n[13] \"ADDRESS STREET NAME\"                                                  \n[14] \"ADDRESS STREET SUFFIX\"                                                \n[15] \"ZIP CODE\"                                                             \n[16] \"X COORDINATE\"                                                         \n[17] \"Y COORDINATE\"                                                         \n[18] \"Ward\"                                                                 \n[19] \"Police District\"                                                      \n[20] \"Community Area\"                                                       \n[21] \"LATITUDE\"                                                             \n[22] \"LONGITUDE\"                                                            \n[23] \"Location\"                                                             \n```\n\n\n:::\n\n```{.r .cell-code}\nbuildings <- building_raw %>%\n  # Remove rows without coordinates\n  filter(!is.na(`X COORDINATE`), !is.na(`Y COORDINATE`)) %>%\n  # Convert to sf object - coordinates are in State Plane\n  st_as_sf(coords = c(\"X COORDINATE\", \"Y COORDINATE\"), crs = 3435) %>%  \n  # Transform to the CRS used in the exercise (ESRI:102271)\n  st_transform('ESRI:102271')\n\n\ncat(\"\\n✓ Loaded abandoned buildings data\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n✓ Loaded abandoned buildings data\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Number of building reports:\", nrow(buildings), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Number of building reports: 65082 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - CRS:\", st_crs(buildings)$input, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - CRS: ESRI:102271 \n```\n\n\n:::\n:::\n\n\nLoading the 311 service requests for vacant and abandoned buildings and converting them to a spatial format that matches our other Chicago data.\n\n## Visualize Building Distribution\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_sf(data = buildings, color = \"#d62828\", size = 0.1, alpha = 0.4) +\n  labs(\n    title = \"Vacant & Abandoned Building Locations\",\n    subtitle = paste0(\"Chicago, n = \", format(nrow(buildings), big.mark = \",\"))\n  )\n\n\nbuildings_coords_plot <- as.data.frame(st_coordinates(buildings))\nnames(buildings_coords_plot) <- c(\"X\", \"Y\")\n\np2 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_density_2d_filled(\n    data = buildings_coords_plot,\n    aes(x = X, y = Y),\n    alpha = 0.7,\n    bins = 8\n  ) +\n  scale_fill_viridis_d(\n    option = \"plasma\",\n    direction = -1,\n    guide = \"none\"\n  ) +\n  labs(\n    title = \"Density Surface\",\n    subtitle = \"Kernel density estimation\"\n  )\n\n\np1 + p2 + \n  plot_annotation(\n    title = \"Spatial Distribution of Vacant & Abandoned Buildings in Chicago\",\n    tag_levels = 'A'\n  )\n```\n\n::: {.cell-output-display}\n![](Zhang_Ye_Assignment4_files/figure-html/visualize-points-1.png){width=1152}\n:::\n:::\n\n\nVacant and abandoned buildings are not evenly distributed across Chicago. The density surface reveals distinct concentration patterns with hot spots appearing in specific neighborhoods. There are clear clusters in the central and also south part of the city. High cluster in the south part of the city.\n\n# Part 2: Create Fishnet Grid\n\n## Create the Grid\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet <- st_make_grid(\n  chicagoBoundary,\n  cellsize = 500,  \n  square = TRUE\n) %>%\n  st_sf() %>%\n  mutate(uniqueID = row_number())\n\n\nfishnet <- fishnet[chicagoBoundary, ]\n\ncat(\"✓ Created fishnet grid\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Created fishnet grid\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Number of cells:\", nrow(fishnet), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Number of cells: 2458 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Cell size: 500 x 500 meters\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Cell size: 500 x 500 meters\n```\n\n\n:::\n:::\n\n\nCreating a grid of 500m x 500m squares that covers Chicago. This converts our point data into a regular grid that's easier to analyze and model.\n\n## Aggregate Buildings to Grid Cells\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbuildings_fishnet <- st_join(buildings, fishnet, join = st_within) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarize(countBuildings = n())\n\n\nfishnet <- fishnet %>%\n  left_join(buildings_fishnet, by = \"uniqueID\") %>%\n  mutate(countBuildings = replace_na(countBuildings, 0))\n\n\ncat(\"\\nBuilding count distribution:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nBuilding count distribution:\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fishnet$countBuildings)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   0.00    1.00    7.00   26.47   28.00  378.00 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nCells with zero buildings:\", \n    sum(fishnet$countBuildings == 0), \n    \"/\", nrow(fishnet),\n    \"(\", round(100 * sum(fishnet$countBuildings == 0) / nrow(fishnet), 1), \"%)\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCells with zero buildings: 542 / 2458 ( 22.1 %)\n```\n\n\n:::\n:::\n\n\nCounting how many abandoned building reports occurred in each grid cell.\n\n## Visualize the Grid\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Map the counts in each grid cell\nggplot() +\n  geom_sf(data = fishnet, aes(fill = countBuildings), color = NA) +\n  scale_fill_viridis_c(\n    name = \"Abandoned\\nBuildings\",\n    option = \"plasma\",\n    trans = \"sqrt\"  \n  ) +\n  labs(\n    title = \"Vacant & Abandoned Buildings by 500m Grid Cell\",\n    subtitle = \"Chicago\"\n  ) +\n  theme_buildings()\n```\n\n::: {.cell-output-display}\n![](Zhang_Ye_Assignment4_files/figure-html/visualize-fishnet-1.png){width=768}\n:::\n:::\n\n\nThe fishnet grid reveals clear spatial concentration of abandoned building reports. The highest counts cluster in south part of the city. Many cells have zero reports, while some hot spot cells have significantly elevated counts, indicating neighborhoods with persistent vacancy and abandonment issues.\n\n# Part 3: Spatial Features\n\n## Calculate k-Nearest Neighbors\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbuildings_coords <- st_coordinates(buildings)\n\n\nfishnet_coords <- st_coordinates(st_centroid(fishnet))\n\n\nnn_distances <- get.knnx(\n  data = buildings_coords,  \n  query = fishnet_coords,   \n  k = 5                    \n)\n\n\nfishnet <- fishnet %>%\n  mutate(\n    buildings.nn = rowMeans(nn_distances$nn.dist)\n  )\n\ncat(\"✓ Calculated k-nearest neighbors\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Calculated k-nearest neighbors\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - k = 5 nearest buildings\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - k = 5 nearest buildings\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Mean distance:\", round(mean(fishnet$buildings.nn), 1), \"meters\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Mean distance: 291.5 meters\n```\n\n\n:::\n:::\n\n\nFor each grid cell, we find the average distance to the 5 nearest abandoned building reports. This measures how close each cell is to existing abandoned buildings.\n\n## Visualize k-NN Feature\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = buildings.nn), color = NA) +\n  scale_fill_viridis_c(\n    name = \"Mean Distance\\nto 5 Nearest\\nBuildings (m)\",\n    option = \"viridis\",\n    direction = -1\n  ) +\n  labs(\n    title = \"Average Distance to Nearest Abandoned Buildings\",\n    subtitle = \"Lower values = closer to existing abandoned buildings\"\n  ) +\n  theme_buildings()\n```\n\n::: {.cell-output-display}\n![](Zhang_Ye_Assignment4_files/figure-html/visualize-knn-1.png){width=768}\n:::\n:::\n\n\nThe k-NN map shows the consistent yellow coloring across most of the city suggests that abandoned buildings are a pervasive issue affecting nearly all neighborhoods rather than being isolated to just a few problem areas.\n\n# Part 4: Local Moran's I Analysis\n\n## Calculate Local Moran's I\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords <- st_centroid(fishnet) %>% st_coordinates()\nweight_matrix <- knn2nb(knearneigh(coords, k = 4))\nweights <- nb2listw(weight_matrix, style = \"W\", zero.policy = TRUE)\n\n\nfishnet <- fishnet %>%\n  mutate(\n    # Calculate local Moran's I statistic\n    localMorans = localmoran(countBuildings, weights, zero.policy = TRUE)[,1],\n    # Get p-values\n    localMorans_pval = localmoran(countBuildings, weights, zero.policy = TRUE)[,5]\n  )\n\nfishnet <- fishnet %>%\n  mutate(\n    cluster = case_when(\n      localMorans_pval > 0.05 ~ \"Not Significant\",\n      localMorans > 0 & countBuildings > median(countBuildings) ~ \"High-High (Hot Spot)\",\n      localMorans > 0 & countBuildings <= median(countBuildings) ~ \"Low-Low (Cold Spot)\",\n      localMorans < 0 & countBuildings > median(countBuildings) ~ \"High-Low (Outlier)\",\n      localMorans < 0 & countBuildings <= median(countBuildings) ~ \"Low-High (Outlier)\",\n      TRUE ~ \"Not Significant\"\n    )\n  )\n\n# Summary\ncat(\"Cluster distribution:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCluster distribution:\n```\n\n\n:::\n\n```{.r .cell-code}\ntable(fishnet$cluster)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nHigh-High (Hot Spot)   High-Low (Outlier)   Low-High (Outlier) \n                 270                    6                    2 \n     Not Significant \n                2180 \n```\n\n\n:::\n:::\n\n\nLocal Moran's I identifies clusters of similar values. Hot spots are high-abandonment areas surrounded by high-abandonment neighbors. Cold spots are low-abandonment areas surrounded by low-abandonment neighbors.\n\n## Visualize Hot Spots\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Map 1: Cluster types\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = cluster), color = NA) +\n  scale_fill_manual(\n    name = \"Cluster Type\",\n    values = c(\n      \"High-High (Hot Spot)\" = \"#d7191c\",\n      \"Low-Low (Cold Spot)\" = \"#2c7bb6\",\n      \"High-Low (Outlier)\" = \"#fdae61\",\n      \"Low-High (Outlier)\" = \"#abd9e9\",\n      \"Not Significant\" = \"gray90\"\n    )\n  ) +\n  labs(\n    title = \"Local Moran's I Clusters\",\n    subtitle = \"Spatial autocorrelation of vacant & abandoned buildings\"\n  ) +\n  theme_buildings()\n\n# Map 2: Local Moran's I values\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = localMorans), color = NA) +\n  scale_fill_gradient2(\n    name = \"Local\\nMoran's I\",\n    low = \"#2c7bb6\",\n    mid = \"white\",\n    high = \"#d7191c\",\n    midpoint = 0\n  ) +\n  labs(\n    title = \"Local Moran's I Values\",\n    subtitle = \"Positive = similar neighbors, Negative = dissimilar neighbors\"\n  ) +\n  theme_buildings()\n\np1 + p2\n```\n\n::: {.cell-output-display}\n![](Zhang_Ye_Assignment4_files/figure-html/visualize-morans-1.png){width=960}\n:::\n:::\n\n\nThe hot spot analysis identifies concentrated high-abandonment clusters in south Chicago neighborhoods and some in the north central. Cold spots appear to scatter around and there are very few of them. The spatial clustering is statistically significant, confirming that building abandonment is not randomly distributed but concentrates in neighborhoods that might experiencing disinvestment.\n\n## Calculate Distance to Hot Spots\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotspots <- fishnet %>%\n  filter(cluster == \"High-High (Hot Spot)\")\n\ncat(\"Number of hot spots identified:\", nrow(hotspots), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNumber of hot spots identified: 270 \n```\n\n\n:::\n\n```{.r .cell-code}\nif(nrow(hotspots) > 0) {\n  # Get coordinates\n  hotspot_coords <- st_coordinates(st_centroid(hotspots))\n  fishnet_coords <- st_coordinates(st_centroid(fishnet))\n  \n\n  nn_to_hotspot <- get.knnx(\n    data = hotspot_coords,\n    query = fishnet_coords,\n    k = 1\n  )\n  \n\n  fishnet <- fishnet %>%\n    mutate(\n      dist_to_hotspot = nn_to_hotspot$nn.dist[,1]\n    )\n  \n  cat(\"✓ Calculated distance to nearest hot spot\\n\")\n  cat(\"  - Number of hot spots:\", nrow(hotspots), \"\\n\")\n  cat(\"  - Mean distance to hot spot:\", round(mean(fishnet$dist_to_hotspot), 1), \"meters\\n\")\n} else {\n  # If no hot spots, create a placeholder distance variable\n  fishnet <- fishnet %>%\n    mutate(dist_to_hotspot = 0)\n  cat(\"⚠ No hot spots identified - using placeholder distance variable\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Calculated distance to nearest hot spot\n  - Number of hot spots: 270 \n  - Mean distance to hot spot: 3873.7 meters\n```\n\n\n:::\n:::\n\n\nMeasuring how far each grid cell is from the nearest identified hot spot of building abandonment.\n\n## Visualize Distance to Hot Spots\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif(nrow(hotspots) > 0) {\n  ggplot() +\n    geom_sf(data = fishnet, aes(fill = dist_to_hotspot), color = NA) +\n    scale_fill_viridis_c(\n      name = \"Distance to\\nNearest Hot Spot\\n(meters)\",\n      option = \"magma\",\n      direction = -1\n    ) +\n    labs(\n      title = \"Distance to Nearest Abandonment Hot Spot\",\n      subtitle = \"Lower values = closer to hot spots\"\n    ) +\n    theme_buildings()\n} else {\n  cat(\"No hot spots to visualize\\n\")\n}\n```\n\n::: {.cell-output-display}\n![](Zhang_Ye_Assignment4_files/figure-html/visualize-dist-hotspot-1.png){width=768}\n:::\n:::\n\n\nThe map shows clear concentric rings radiating outward from a central hot spot in Chicago, where the lightest (near-zero distance) areas indicate the core abandonment cluster. The gradient pattern reveals that most of the northern of the city is relatively close to this hot spot, while the far north and some southern areas are more isolated from the main abandonment concentration, suggesting these neighborhoods may be less affected by the spillover effects of concentrated building vacancy.\n\n# Part 4: Count Regression Models\n\n## Prepare Modeling Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet_model <- fishnet %>%\n  st_join(policeDistricts, join = st_intersects, left = TRUE) %>%\n  st_drop_geometry() %>%\n  filter(!is.na(District))  # Remove cells outside districts\n\nfishnet_model <- fishnet_model %>%\n  mutate(\n    buildings.nn_scaled = scale(buildings.nn)[,1],\n    dist_to_hotspot_scaled = scale(dist_to_hotspot)[,1]\n  )\n\ncat(\"✓ Prepared modeling dataset\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Prepared modeling dataset\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Number of cells:\", nrow(fishnet_model), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Number of cells: 2891 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Number of districts:\", n_distinct(fishnet_model$District), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Number of districts: 23 \n```\n\n\n:::\n:::\n\n\nPreparing our data for modeling by joining it with police districts (for cross-validation) and creating scaled versions of our predictor variables.\n\n## Fit Poisson Regression\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_poisson <- glm(\n  countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n  data = fishnet_model,\n  family = poisson()\n)\n\n\nsummary(model_poisson)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled, \n    family = poisson(), data = fishnet_model)\n\nCoefficients:\n                       Estimate Std. Error z value            Pr(>|z|)    \n(Intercept)             1.06854    0.01458    73.3 <0.0000000000000002 ***\nbuildings.nn_scaled    -3.36737    0.02359  -142.7 <0.0000000000000002 ***\ndist_to_hotspot_scaled -0.92218    0.00901  -102.4 <0.0000000000000002 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 151530  on 2890  degrees of freedom\nResidual deviance:  23630  on 2888  degrees of freedom\nAIC: 33755\n\nNumber of Fisher Scoring iterations: 5\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nPoisson Model AIC:\", AIC(model_poisson), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nPoisson Model AIC: 33755.26 \n```\n\n\n:::\n:::\n\n\nFitting a Poisson regression model that predicts building counts using distance to nearest buildings and distance to hot spots.\n\n## Fit Negative Binomial Regression\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"Data diagnostics:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nData diagnostics:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Building count range:\", min(fishnet_model$countBuildings), \"to\", max(fishnet_model$countBuildings), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nBuilding count range: 0 to 378 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Mean:\", round(mean(fishnet_model$countBuildings), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean: 26.82 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Variance:\", round(var(fishnet_model$countBuildings), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nVariance: 2084.37 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Variance/Mean ratio:\", round(var(fishnet_model$countBuildings)/mean(fishnet_model$countBuildings), 2), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nVariance/Mean ratio: 77.72 \n```\n\n\n:::\n\n```{.r .cell-code}\nmodel_nb <- tryCatch({\n  cat(\"Trying NB model with scaled predictors...\\n\")\n  glm.nb(\n    countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n    data = fishnet_model,\n    control = glm.control(maxit = 100)\n  )\n}, error = function(e1) {\n  cat(\"Direct fit failed. Trying with Poisson starting values...\\n\")\n  \n  model_poisson_scaled <- glm(\n    countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n    data = fishnet_model,\n    family = poisson()\n  )\n  \n  tryCatch({\n    glm.nb(\n      countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n      data = fishnet_model,\n      start = coef(model_poisson_scaled),\n      init.theta = 1,\n      control = glm.control(maxit = 200, epsilon = 1e-4)\n    )\n  }, error = function(e2) {\n    cat(\"Still failing. Trying with subset of data to estimate theta...\\n\")\n    \n    fishnet_subset <- fishnet_model %>%\n      filter(countBuildings < quantile(countBuildings, 0.95))\n    \n    model_subset <- glm.nb(\n      countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n      data = fishnet_subset\n    )\n    \n    glm.nb(\n      countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n      data = fishnet_model,\n      start = coef(model_subset),\n      init.theta = model_subset$theta,\n      control = glm.control(maxit = 200, epsilon = 1e-4)\n    )\n  })\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTrying NB model with scaled predictors...\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(model_nb)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm.nb(formula = countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled, \n    data = fishnet_model, control = glm.control(maxit = 100), \n    init.theta = 3.469696575, link = log)\n\nCoefficients:\n                       Estimate Std. Error z value            Pr(>|z|)    \n(Intercept)             1.08864    0.02663   40.88 <0.0000000000000002 ***\nbuildings.nn_scaled    -3.79635    0.05148  -73.75 <0.0000000000000002 ***\ndist_to_hotspot_scaled -0.48137    0.01711  -28.13 <0.0000000000000002 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for Negative Binomial(3.4697) family taken to be 1)\n\n    Null deviance: 21692.6  on 2890  degrees of freedom\nResidual deviance:  2658.7  on 2888  degrees of freedom\nAIC: 16847\n\nNumber of Fisher Scoring iterations: 1\n\n              Theta:  3.470 \n          Std. Err.:  0.124 \n\n 2 x log-likelihood:  -16839.458 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Compare AIC (lower is better)\ncat(\"\\nModel Comparison:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nModel Comparison:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Poisson AIC:\", round(AIC(model_poisson), 1), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPoisson AIC: 33755.3 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Negative Binomial AIC:\", round(AIC(model_nb), 1), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNegative Binomial AIC: 16847.5 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\n✓ Model fitted successfully\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n✓ Model fitted successfully\n```\n\n\n:::\n:::\n\n\nThe lower AIC tells us which model fits better. Negative Binomial has a better fit through having a lower AIC. This large difference indicates that the data exhibits severe overdispersion - meaning the variance in abandoned building counts is much greater than the mean. The Poisson model's assumption that mean equals variance is strongly violated, making the Negative Binomial model the clearly superior choice for modeling this data. This overdispersion is typical in urban abandonment data where most areas have few or no abandoned buildings, but some hot spot areas have very high concentrations.\n\n# Part 5: Spatial Cross-Validation (2017)\n\n## Implement Leave-One-Group-Out CV\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndistricts <- unique(fishnet_model$District)\n\n\ncv_results <- tibble()\n\ncat(\"Running Leave-One-Group-Out Cross-Validation...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRunning Leave-One-Group-Out Cross-Validation...\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"(\", length(districts), \"folds - one per district)\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n( 23 folds - one per district)\n```\n\n\n:::\n\n```{.r .cell-code}\nfor(i in 1:length(districts)) {\n  test_district <- districts[i]\n  \n\n  train_data <- fishnet_model %>% filter(District != test_district)\n  test_data <- fishnet_model %>% filter(District == test_district)\n  \n  \n  model_cv <- tryCatch({\n    glm.nb(\n      countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n      data = train_data,\n      control = glm.control(maxit = 100)\n    )\n  }, error = function(e) {\n\n    model_poisson_cv <- glm(\n      countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n      data = train_data,\n      family = poisson()\n    )\n    \n    tryCatch({\n      glm.nb(\n        countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n        data = train_data,\n        start = coef(model_poisson_cv),\n        init.theta = 1,\n        control = glm.control(maxit = 100)\n      )\n    }, error = function(e2) {\n  \n      train_subset <- train_data %>%\n        filter(countBuildings < quantile(countBuildings, 0.95))\n      \n      model_subset <- glm.nb(\n        countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n        data = train_subset\n      )\n      \n      glm.nb(\n        countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n        data = train_data,\n        start = coef(model_subset),\n        init.theta = model_subset$theta,\n        control = glm.control(maxit = 100)\n      )\n    })\n  })\n  \n\n  test_data <- test_data %>%\n    mutate(\n      prediction = predict(model_cv, test_data, type = \"response\")\n    )\n  \n\n  mae <- mean(abs(test_data$countBuildings - test_data$prediction))\n  rmse <- sqrt(mean((test_data$countBuildings - test_data$prediction)^2))\n  \n\n  cv_results <- bind_rows(\n    cv_results,\n    tibble(\n      fold = i,\n      test_district = test_district,\n      n_test = nrow(test_data),\n      mae = mae,\n      rmse = rmse\n    )\n  )\n  \n  cat(\"  Fold\", i, \"/\", length(districts), \"- District\", test_district, \n      \"- MAE:\", round(mae, 2), \"\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Fold 1 / 23 - District 5 - MAE: 17.77 \n  Fold 2 / 23 - District 4 - MAE: 9.2 \n  Fold 3 / 23 - District 22 - MAE: 12.62 \n  Fold 4 / 23 - District 31 - MAE: 1.08 \n  Fold 5 / 23 - District 6 - MAE: 22.23 \n  Fold 6 / 23 - District 8 - MAE: 10.16 \n  Fold 7 / 23 - District 7 - MAE: 70.75 \n  Fold 8 / 23 - District 3 - MAE: 22.32 \n  Fold 9 / 23 - District 2 - MAE: 9.29 \n  Fold 10 / 23 - District 9 - MAE: 15 \n  Fold 11 / 23 - District 10 - MAE: 13.82 \n  Fold 12 / 23 - District 1 - MAE: 1.76 \n  Fold 13 / 23 - District 12 - MAE: 9.04 \n  Fold 14 / 23 - District 15 - MAE: 21.81 \n  Fold 15 / 23 - District 11 - MAE: 32.54 \n  Fold 16 / 23 - District 18 - MAE: 1.42 \n  Fold 17 / 23 - District 25 - MAE: 14.23 \n  Fold 18 / 23 - District 14 - MAE: 12.21 \n  Fold 19 / 23 - District 19 - MAE: 3.51 \n  Fold 20 / 23 - District 16 - MAE: 2.12 \n  Fold 21 / 23 - District 17 - MAE: 2.93 \n  Fold 22 / 23 - District 20 - MAE: 1.98 \n  Fold 23 / 23 - District 24 - MAE: 2.6 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\n✓ Cross-Validation Complete\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n✓ Cross-Validation Complete\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Mean MAE:\", round(mean(cv_results$mae), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean MAE: 13.49 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Mean RMSE:\", round(mean(cv_results$rmse), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean RMSE: 21.48 \n```\n\n\n:::\n:::\n\n\nTesting our model by holding out one police district at a time, training on the rest, and seeing how well we predict the held-out district.\n\n## Cross-Validation Results\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_results %>%\n  arrange(desc(mae)) %>%\n  kable(\n    digits = 2,\n    caption = \"LOGO CV Results by District\",\n    col.names = c(\"Fold\", \"District\", \"N Test Cells\", \"MAE\", \"RMSE\")\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>LOGO CV Results by District</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> Fold </th>\n   <th style=\"text-align:left;\"> District </th>\n   <th style=\"text-align:right;\"> N Test Cells </th>\n   <th style=\"text-align:right;\"> MAE </th>\n   <th style=\"text-align:right;\"> RMSE </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:right;\"> 86 </td>\n   <td style=\"text-align:right;\"> 70.75 </td>\n   <td style=\"text-align:right;\"> 96.35 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 15 </td>\n   <td style=\"text-align:left;\"> 11 </td>\n   <td style=\"text-align:right;\"> 79 </td>\n   <td style=\"text-align:right;\"> 32.54 </td>\n   <td style=\"text-align:right;\"> 48.31 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:right;\"> 86 </td>\n   <td style=\"text-align:right;\"> 22.32 </td>\n   <td style=\"text-align:right;\"> 34.01 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:right;\"> 109 </td>\n   <td style=\"text-align:right;\"> 22.23 </td>\n   <td style=\"text-align:right;\"> 30.62 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 14 </td>\n   <td style=\"text-align:left;\"> 15 </td>\n   <td style=\"text-align:right;\"> 60 </td>\n   <td style=\"text-align:right;\"> 21.81 </td>\n   <td style=\"text-align:right;\"> 34.21 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:right;\"> 170 </td>\n   <td style=\"text-align:right;\"> 17.77 </td>\n   <td style=\"text-align:right;\"> 33.61 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> 9 </td>\n   <td style=\"text-align:right;\"> 167 </td>\n   <td style=\"text-align:right;\"> 15.00 </td>\n   <td style=\"text-align:right;\"> 27.44 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 17 </td>\n   <td style=\"text-align:left;\"> 25 </td>\n   <td style=\"text-align:right;\"> 135 </td>\n   <td style=\"text-align:right;\"> 14.23 </td>\n   <td style=\"text-align:right;\"> 20.45 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:left;\"> 10 </td>\n   <td style=\"text-align:right;\"> 111 </td>\n   <td style=\"text-align:right;\"> 13.82 </td>\n   <td style=\"text-align:right;\"> 23.45 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 22 </td>\n   <td style=\"text-align:right;\"> 187 </td>\n   <td style=\"text-align:right;\"> 12.62 </td>\n   <td style=\"text-align:right;\"> 22.26 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 18 </td>\n   <td style=\"text-align:left;\"> 14 </td>\n   <td style=\"text-align:right;\"> 84 </td>\n   <td style=\"text-align:right;\"> 12.21 </td>\n   <td style=\"text-align:right;\"> 19.07 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> 8 </td>\n   <td style=\"text-align:right;\"> 281 </td>\n   <td style=\"text-align:right;\"> 10.16 </td>\n   <td style=\"text-align:right;\"> 18.74 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:right;\"> 99 </td>\n   <td style=\"text-align:right;\"> 9.29 </td>\n   <td style=\"text-align:right;\"> 15.71 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:right;\"> 325 </td>\n   <td style=\"text-align:right;\"> 9.20 </td>\n   <td style=\"text-align:right;\"> 22.08 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 13 </td>\n   <td style=\"text-align:left;\"> 12 </td>\n   <td style=\"text-align:right;\"> 127 </td>\n   <td style=\"text-align:right;\"> 9.04 </td>\n   <td style=\"text-align:right;\"> 15.44 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 19 </td>\n   <td style=\"text-align:left;\"> 19 </td>\n   <td style=\"text-align:right;\"> 116 </td>\n   <td style=\"text-align:right;\"> 3.51 </td>\n   <td style=\"text-align:right;\"> 7.12 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 21 </td>\n   <td style=\"text-align:left;\"> 17 </td>\n   <td style=\"text-align:right;\"> 126 </td>\n   <td style=\"text-align:right;\"> 2.93 </td>\n   <td style=\"text-align:right;\"> 4.94 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 23 </td>\n   <td style=\"text-align:left;\"> 24 </td>\n   <td style=\"text-align:right;\"> 76 </td>\n   <td style=\"text-align:right;\"> 2.60 </td>\n   <td style=\"text-align:right;\"> 3.67 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20 </td>\n   <td style=\"text-align:left;\"> 16 </td>\n   <td style=\"text-align:right;\"> 224 </td>\n   <td style=\"text-align:right;\"> 2.12 </td>\n   <td style=\"text-align:right;\"> 3.70 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 22 </td>\n   <td style=\"text-align:left;\"> 20 </td>\n   <td style=\"text-align:right;\"> 61 </td>\n   <td style=\"text-align:right;\"> 1.98 </td>\n   <td style=\"text-align:right;\"> 3.28 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 12 </td>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:right;\"> 71 </td>\n   <td style=\"text-align:right;\"> 1.76 </td>\n   <td style=\"text-align:right;\"> 4.14 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 16 </td>\n   <td style=\"text-align:left;\"> 18 </td>\n   <td style=\"text-align:right;\"> 74 </td>\n   <td style=\"text-align:right;\"> 1.42 </td>\n   <td style=\"text-align:right;\"> 3.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> 31 </td>\n   <td style=\"text-align:right;\"> 37 </td>\n   <td style=\"text-align:right;\"> 1.08 </td>\n   <td style=\"text-align:right;\"> 2.55 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nSpatial cross-validation (LOGO CV) is more appropriate than random CV because of spatial autocorrelation - nearby locations tend to have similar characteristics. District 7 had the highest MAE and RMSE, indicating it has unique abandonment patterns not well-captured by the model's spatial features or differs significantly from other districts in the training data.\n\n# Part 6: Model Evaluation\n\n## Generate Final Predictions\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet <- fishnet %>%\n  mutate(\n    buildings.nn_scaled = (buildings.nn - mean(fishnet_model$buildings.nn, na.rm = TRUE)) / \n                         sd(fishnet_model$buildings.nn, na.rm = TRUE),\n    dist_to_hotspot_scaled = (dist_to_hotspot - mean(fishnet_model$dist_to_hotspot, na.rm = TRUE)) / \n                              sd(fishnet_model$dist_to_hotspot, na.rm = TRUE)\n  )\n\nfinal_model <- tryCatch({\n  cat(\"Fitting final NB model...\\n\")\n  glm.nb(\n    countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n    data = fishnet_model,\n    control = glm.control(maxit = 100)\n  )\n}, error = function(e) {\n  cat(\"Using Poisson starting values for final model...\\n\")\n  \n  model_poisson_final <- glm(\n    countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n    data = fishnet_model,\n    family = poisson()\n  )\n  \n  tryCatch({\n    glm.nb(\n      countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n      data = fishnet_model,\n      start = coef(model_poisson_final),\n      init.theta = 1,\n      control = glm.control(maxit = 200)\n    )\n  }, error = function(e2) {\n    # Last resort\n    fishnet_subset <- fishnet_model %>%\n      filter(countBuildings < quantile(countBuildings, 0.95))\n    \n    model_subset <- glm.nb(\n      countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n      data = fishnet_subset\n    )\n    \n    glm.nb(\n      countBuildings ~ buildings.nn_scaled + dist_to_hotspot_scaled,\n      data = fishnet_model,\n      start = coef(model_subset),\n      init.theta = model_subset$theta,\n      control = glm.control(maxit = 200)\n    )\n  })\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFitting final NB model...\n```\n\n\n:::\n\n```{.r .cell-code}\npred_data <- fishnet %>%\n  st_drop_geometry() %>%\n  dplyr::select(uniqueID, buildings.nn_scaled, dist_to_hotspot_scaled)\n\nfishnet <- fishnet %>%\n  mutate(\n    prediction_nb = predict(final_model, pred_data, type = \"response\")\n  )\n\ncat(\"✓ Final predictions generated\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Final predictions generated\n```\n\n\n:::\n:::\n\n\n## Compare to KDE Baseline\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbuildings_ppp <- as.ppp(st_coordinates(buildings), W = as.owin(chicagoBoundary))\n\n\nkde_buildings <- density.ppp(buildings_ppp, sigma = 1000)\n\n\nkde_raster <- rast(kde_buildings)\nfishnet <- fishnet %>%\n  mutate(\n    kde_value = terra::extract(kde_raster, st_centroid(fishnet))[,2]\n  )\n\n\nkde_sum <- sum(fishnet$kde_value, na.rm = TRUE)\ncount_sum <- sum(fishnet$countBuildings, na.rm = TRUE)\nfishnet <- fishnet %>%\n  mutate(\n    prediction_kde = (kde_value / kde_sum) * count_sum\n  )\n```\n:::\n\n\n## Visualize Predictions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create three maps\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = countBuildings), color = NA) +\n  scale_fill_viridis_c(name = \"Count\", option = \"plasma\", limits = c(0, 50)) +\n  labs(title = \"Actual Building Reports\") +\n  theme_buildings()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = prediction_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 50)) +\n  labs(title = \"Model Predictions (Neg. Binomial)\") +\n  theme_buildings()\n\np3 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = prediction_kde), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 50)) +\n  labs(title = \"KDE Baseline Predictions\") +\n  theme_buildings()\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Actual vs. Predicted Vacant & Abandoned Buildings\"\n  )\n```\n\n::: {.cell-output-display}\n![](Zhang_Ye_Assignment4_files/figure-html/visualize-predictions-1.png){width=1152}\n:::\n:::\n\n\n## Model Performance Comparison\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate performance metrics\ncomparison <- fishnet %>%\n  st_drop_geometry() %>%\n  filter(!is.na(prediction_nb), !is.na(prediction_kde)) %>%\n  summarize(\n    model_mae = mean(abs(countBuildings - prediction_nb)),\n    model_rmse = sqrt(mean((countBuildings - prediction_nb)^2)),\n    kde_mae = mean(abs(countBuildings - prediction_kde)),\n    kde_rmse = sqrt(mean((countBuildings - prediction_kde)^2))\n  )\n\ncomparison %>%\n  pivot_longer(everything(), names_to = \"metric\", values_to = \"value\") %>%\n  separate(metric, into = c(\"approach\", \"metric\"), sep = \"_\") %>%\n  pivot_wider(names_from = metric, values_from = value) %>%\n  kable(\n    digits = 2,\n    caption = \"Model Performance Comparison\",\n    col.names = c(\"Approach\", \"MAE\", \"RMSE\")\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Model Performance Comparison</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Approach </th>\n   <th style=\"text-align:right;\"> MAE </th>\n   <th style=\"text-align:right;\"> RMSE </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> model </td>\n   <td style=\"text-align:right;\"> 13.50 </td>\n   <td style=\"text-align:right;\"> 28.35 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> kde </td>\n   <td style=\"text-align:right;\"> 15.66 </td>\n   <td style=\"text-align:right;\"> 27.79 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThe Negative Binomial model slightly beats the KDE baseline with a MAE of 13.50 versus 15.66, meaning it's off by about 2 fewer buildings per cell - a modest 14% improvement. While the performance gain isn't huge, the model provides insight into why certain areas are at risk by showing that proximity to abandoned buildings and hot spots matters for prediction. Both approaches struggle in the same places, particularly underpredicting the most intense abandonment areas in the central west corridor and overpredicting in moderate zones.\n\n## Map Prediction Errors\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet <- fishnet %>%\n  mutate(\n    error_nb = countBuildings - prediction_nb,\n    abs_error_nb = abs(error_nb)\n  )\n\n\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = error_nb), color = NA) +\n  scale_fill_gradient2(\n    name = \"Error\",\n    low = \"#2166ac\", mid = \"white\", high = \"#b2182b\",\n    midpoint = 0,\n    limits = c(-20, 20)\n  ) +\n  labs(title = \"Model Errors (Actual - Predicted)\",\n       subtitle = \"Red = underpredicted, Blue = overpredicted\") +\n  theme_buildings()\n\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = abs_error_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Abs. Error\", option = \"magma\") +\n  labs(title = \"Absolute Model Errors\") +\n  theme_buildings()\n\np1 + p2\n```\n\n::: {.cell-output-display}\n![](Zhang_Ye_Assignment4_files/figure-html/prediction-errors-1.png){width=960}\n:::\n:::\n\n\nThe error maps show a fairly balanced mix of underprediction (red) and overprediction (blue) scattered throughout the city, with no strong systematic spatial bias in the signed errors. However, the absolute error map reveals that the largest mistakes concentrate in specific hotspot areas in the central and western parts of Chicago, indicating the model struggles most with neighborhoods experiencing the most severe abandonment where counts are highest and most variable.\n\n# Conclusion\n\n**Model Performance:**\n\n-   Our Negative Binomial model significantly outperformed Poisson (AIC: 16,847 vs 33,755), confirming severe overdispersion in the data where variance far exceeds the mean\n\n-   Cross-validation showed reasonable generalization with District 7 being the hardest to predict, indicating some districts have unique abandonment patterns\n\n-   The model slightly outperformed the KDE baseline (MAE: 13.50 vs 15.66), achieving about 14% improvement in prediction accuracy\n\n**Spatial Patterns:**\n\n-   Abandoned buildings show strong spatial clustering, with most of Chicago having relatively short distances to abandoned buildings\n\n-   Hot spots concentrated in west-central Chicago form the core abandonment cluster, with concentric rings showing spillover effects\n\n-   Local Moran's I identified statistically significant hot spots (High-High clusters) primarily in central south neighborhoods\n\n**Model Limitations:**\n\n-   The model underpredicts in the most extreme abandonment areas (central west hotspot) and overpredicts in moderate zones\n\n-   Both the regression model and KDE struggle with the same high-intensity areas, suggesting extreme abandonment is driven by factors beyond spatial proximity\n\n-   If we could add additional features like economic indicators, foreclosure rates, housing age, or policy interventions could address current systematic biases\n",
    "supporting": [
      "Zhang_Ye_Assignment4_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}