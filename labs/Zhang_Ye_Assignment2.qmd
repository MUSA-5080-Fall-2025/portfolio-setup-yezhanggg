---
title: "Assignment 2: Spatial Analysis and Visualization"
subtitle: "Healthcare Access and Equity in Pennsylvania"
author: "Ye Zhang"
date: Oct.14.2025
format: 
  html:
    code-fold: false
    toc: true
    toc-location: left
    theme: cosmo
    embed-resources: true
execute:
  warning: false
  message: false
---

## Assignment Overview

**Learning Objectives:**
- Apply spatial operations to answer policy-relevant research questions
- Integrate census demographic data with spatial analysis
- Create publication-quality visualizations and maps
- Work with spatial data from multiple sources
- Communicate findings effectively for policy audiences

---

## Part 1: Healthcare Access for Vulnerable Populations

### Research Question

**Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**

#### Step 1: Data Collection (5 points)
```{r}
# Load required packages
library(sf)
library(tidyverse)
library(tigris)
library(tidycensus)
library(scales)
library(patchwork)
library(here)

census_api_key("138db656646183a18ae51e4a7c1e1f5cd64d4b40")
install = TRUE

# Load spatial data

pa_counties <- st_read(here("~/Documents/GitHub/portfolio-setup-yezhanggg/labs/assignment_2_data/Pennsylvania_County_Boundaries.shp"))
hospitals <- st_read(here("~/Documents/GitHub/portfolio-setup-yezhanggg/labs/assignment_2_data/hospitals.geojson"))
census_tracts <- tracts(state = "PA", cb = TRUE)

# Check that all data loaded correctly

st_crs(pa_counties)
st_crs(hospitals)
st_crs(census_tracts)

```

**Questions to answer:**
- How many hospitals are in your dataset?
  There aer 223 hosptials in my dataset. 
- How many census tracts?
  There are 3445 census tracts.
- What coordinate reference system is each dataset in?
  PA Counties is in WGS 84 Pseudo Mercator, Hospitals is in WGS 84 and Census Tracts is in NAD83.

---

#### Step 2: Get Demographic Data 
```{r}
# Get demographic data from ACS
acs_vars_2022 <- load_variables(2022, "acs5", cache = TRUE)

# Get demographic data from ACS

pa_demographics <- get_acs(
  geography = "tract",
  state = "PA",
  variables = c(
    total_pop = "B01003_001",     
    median_income = "B19013_001",   
    male_65_66 = "B01001_020",
    male_67_69 = "B01001_021",
    male_70_74 = "B01001_022",
    male_75_79 = "B01001_023",
    male_80_84 = "B01001_024",
    male_85_over = "B01001_025",
    female_65_66 = "B01001_044",
    female_67_69 = "B01001_045",
    female_70_74 = "B01001_046",
    female_75_79 = "B01001_047",
    female_80_84 = "B01001_048",
    female_85_over = "B01001_049"
  ),
  year = 2022,
  survey = "acs5",
  output = "wide",
  geometry = FALSE
)

pa_demographics <- pa_demographics %>%
  mutate(
    pop_65_over = male_65_66E + male_67_69E + male_70_74E + male_75_79E + 
                  male_80_84E + male_85_overE + 
                  female_65_66E + female_67_69E + female_70_74E + 
                  female_75_79E + female_80_84E + female_85_overE,
    total_pop = total_popE,
    median_income = median_incomeE
  ) %>%
 select(GEOID, total_pop, median_income, pop_65_over)

# Join to tract boundaries

census_tracts <- census_tracts %>%
  left_join(pa_demographics, by = "GEOID")


```

**Questions to answer:**
- What year of ACS data are you using?
  I am using ACS 2022 data. 
- How many tracts have missing income data?
  There are 62 tracts missing income data. 
- What is the median income across all PA census tracts?
  The median household income is $70,188 for all PA Census Tracts.

---

#### Step 3: Define Vulnerable Populations 
```{r}
# Filter for vulnerable tracts based on your criteria

vulnerable_tracts <- census_tracts %>%
  mutate(pct_elderly = (pop_65_over / total_pop) * 100) %>%
  filter(median_income < 40000 & pct_elderly > 21)

```

**Questions to answer:**
- What income threshold did you choose and why?
The income threshold that I chose is 40000. Through research, the poverty guideline in 2024 for a family of four is 31,200.The median household income in PA is $76,081 in 2023. Older population might be more vulnerable and it would be reasonable to adjust threshold higher. It would be reasonable to use this as the guideline to set for the low median household income threshold. 
- What elderly population threshold did you choose and why?
The elderly population threhold that I choose is 21%. Because after reviewing the acs data, there are 14 different age groups and there are three age groups that include age over 65. 
- How many tracts meet your vulnerability criteria?
There are 59 vulnerable tracts that meet my standard of below 40,000 income and over 21% are elderly people. 
- What percentage of PA census tracts are considered vulnerable by your definition?
1.7% of the PA census tracts are considered as vulnerable by my definition. 

---

#### Step 4: Calculate Distance to Hospitals 
```{r}
# Transform to appropriate projected CRS
pa_counties <- pa_counties %>% st_transform(3365)
hospitals <- hospitals %>% st_transform(3365)
census_tracts <- census_tracts %>% st_transform(3365)
vulnerable_tracts <- vulnerable_tracts %>% st_transform(3365)

# Calculate distance from each tract centroid to nearest hospital
tract_centers <- st_centroid(vulnerable_tracts) 
distance_matrix <- st_distance(tract_centers, hospitals)

min_distances <- apply(distance_matrix, 1, min)

vulnerable_tracts <- vulnerable_tracts %>%
  mutate(
    distance_to_nearest_hospital_m = as.numeric(min_distances),
    distance_to_nearest_hospital_miles = distance_to_nearest_hospital_m / 1609.34
  )
```

**Questions to answer:**
- What is the average distance to the nearest hospital for vulnerable tracts?
The average distance is 7.4093 miles.
- What is the maximum distance?
The max distance is 61.2651 miles
- How many vulnerable tracts are more than 15 miles from the nearest hospital?
Based on my standards. There are 4 vulnerable tracts that are more than 15 miles from the nearest hospital.

```{r}
st_crs(vulnerable_tracts)$units
summary(vulnerable_tracts)
sum(vulnerable_tracts$distance_to_nearest_hospital_miles > 15)
```

---

#### Step 5: Identify Underserved Areas 
```{r}
# Create underserved variable

vulnerable_tracts <- vulnerable_tracts %>%
  mutate(underserved = distance_to_nearest_hospital_miles > 15)

```

**Questions to answer:**
- How many tracts are underserved?
There are 4 tracts that are underserved.
- What percentage of vulnerable tracts are underserved?
The percentage for vulnerable tracts are underserved is 6.78%.
- Does this surprise you? Why or why not?
This percentage is little bit lower than I expected. I was expected the vulnerable tracts that are underserved might takes up a larger percentage. It might be how I designed what is considered as a vulnerable tracts. 

---

#### Step 6: Aggregate to County Level
```{r}
# Spatial join tracts to counties

tracts_with_counties <- vulnerable_tracts %>%
  st_join(pa_counties %>% select(COUNTY_NAM))

# Aggregate statistics by county

vulnerable_by_county <- tracts_with_counties %>%
  st_drop_geometry() %>%
  group_by(COUNTY_NAM) %>%
  summarize(
    n_vulnerable_tracts = n(),
    n_underserved_tracts = sum(underserved == TRUE, na.rm = TRUE),
    pct_vulnerable_underserved = (sum(underserved == TRUE, na.rm = TRUE) / n()) * 100,
    avg_distance_to_hospital = mean(distance_to_nearest_hospital_miles, na.rm = TRUE),
    total_vulnerable_pop = sum(total_pop, na.rm = TRUE)
  ) %>%
  arrange(desc(n_vulnerable_tracts))


vulnerable_by_county %>%
  arrange(desc(pct_vulnerable_underserved)) %>%
  head(5)

vulnerable_by_county %>%
  filter(n_underserved_tracts > 0) %>%
  arrange(desc(total_vulnerable_pop)) %>%
  head(10)

```
**Questions to answer:**
- Which 5 counties have the highest percentage of underserved vulnerable tracts?
Based on my threshold, the top 4 counties with highest percentage of underserved vulnerable tracts. 
- Which counties have the most vulnerable people living far from hospitals?
Allegheny has the most vulnerable people living far from hospitals.
- Are there any patterns in where underserved counties are located?
Underserved counties tends to also have higher vulnerable tracts and higher average distance to hospital. 

---

#### Step 7: Create Summary Table 
```{r}
# Create and format priority counties table

library(knitr)
library(kableExtra)

priority_counties <- vulnerable_by_county %>%
  arrange(desc(pct_vulnerable_underserved)) %>%
  head(10) %>%
  select(
    COUNTY_NAM,
    n_vulnerable_tracts,
    n_underserved_tracts,
    pct_vulnerable_underserved,
    avg_distance_to_hospital,
    total_vulnerable_pop
  )

priority_counties %>%
  kable(
    col.names = c(
      "County",
      "Vulnerable Tracts",
      "Underserved Tracts",
      "% Underserved",
      "Avg Distance (miles)",
      "Vulnerable Population"
    ),
    caption = "Top 10 Priority Counties for Healthcare Investment: Highest Percentage of Underserved Vulnerable Tracts",
    digits = c(0, 0, 0, 1, 1, 0),
    format.args = list(big.mark = ",")
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```
---

## Part 2: Comprehensive Visualization 

### Map 1: County-Level Choropleth 
```{r}
# Create county-level access map

library(scales)

counties_with_stats <- pa_counties %>%
  left_join(vulnerable_by_county, by = "COUNTY_NAM")

ggplot() +
  geom_sf(data = counties_with_stats, 
          aes(fill = pct_vulnerable_underserved), 
          color = "white", 
          size = 0.5) +
  geom_sf(data = hospitals, 
          color = "red", 
          size = 1.5, 
          alpha = 0.6) +
  scale_fill_viridis_c(
    name = "% Vulnerable\nTracts\nUnderserved",
    labels = comma,
    option = "plasma",
    na.value = "lightgray"
  ) +
  labs(
    title = "Healthcare Access Challenges in Pennsylvania Counties",
    subtitle = "Percentage of vulnerable tracts located far from hospitals",
    caption = "Source: ACS 2022 | Red points = Hospital locations"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11),
    legend.position = "right"
  )

```
---

### Map 2: Detailed Vulnerability Map 
```{r}
# Create detailed tract-level map

allegheny <- pa_counties %>%
  filter(COUNTY_NAM == "ALLEGHENY")

allegheny_tracts <- vulnerable_tracts %>%
  st_filter(allegheny)

allegheny_hospitals <- hospitals %>%
  st_filter(allegheny)

ggplot() +
  geom_sf(data = allegheny, 
          fill = "white", 
          color = "black", 
          size = 1) +
  geom_sf(data = allegheny_tracts %>% filter(underserved == FALSE),
          fill = "blue", 
          color = "gray80",
          size = 0.3,
          alpha = 0.6) +
  geom_sf(data = allegheny_tracts %>% filter(underserved == TRUE),
          fill = "red", 
          color = "gray80",
          size = 0.3,
          alpha = 0.7) +
  geom_sf(data = allegheny_hospitals, 
          color = "lightgreen", 
          size = 2, 
          shape = 17) +
  labs(
    title = "Underserved Vulnerable Populations in Allegheny County",
    subtitle = "Red = Underserved tracts | Blue = Vulnerable tracts | Triangles = Hospitals"
  ) +
  theme_void()

```
---

### Chart: Distribution Analysis of distances to hospitals for vulnerable populations.
```{r}
# Create distribution visualization

ggplot(vulnerable_tracts, aes(x = distance_to_nearest_hospital_miles)) +
  geom_histogram(bins = 20, fill = "steelblue", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 15, color = "red", linetype = "dashed", size = 1) +
  labs(
    title = "Distribution of Distance to Nearest Hospital",
    subtitle = "For vulnerable census tracts in Pennsylvania",
    x = "Distance to Nearest Hospital (miles)",
    y = "Number of Vulnerable Tracts",
    caption = "Red dashed line = 15-mile threshold for underserved status. 
    Most vulnerable tracts are within 15 miles of a hospital, but a concerning number remain beyond this threshold."
  ) +
  theme_minimal() +
  scale_x_continuous(labels = comma)


```
---

## Part 3: Bring Your Own Data Analysis 

### Your Analysis

**Option B: School Safety Zones**
- **Data:** Schools, Crime Incidents, Bike Network
- **Question:** "Are school zones safe for walking/biking, or are they crime hotspots?"
- **Operations:** Buffer schools (500m safety zone), spatial join with crime incidents, assess bike infrastructure coverage
- **Policy relevance:** Safe Routes to School programs, crossing guard placement

**Your Task:**

1. **Find and load additional data**

```{r}
# Load your additional dataset


schools <- st_read(here("~/Documents/GitHub/portfolio-setup-yezhanggg/labs/assignment_2_data/Challenege/Schools/Schools.shp"))

crime <- st_read(here("~/Documents/GitHub/portfolio-setup-yezhanggg/labs/assignment_2_data/Challenege/incidents_part1_part2/incidents_part1_part2.shp"))

bike <- st_read(here("~/Documents/GitHub/portfolio-setup-yezhanggg/labs/assignment_2_data/Challenege/Bike_Network/Bike_Network.shp"))

```
```{r}
st_crs(schools)
st_crs(crime)
st_crs(bike)

schools <- st_transform(schools, 3365)
crime <- st_transform(crime, 3365)
bike <- st_transform(bike, 3365)

nrow(schools)
nrow(crime)
nrow(bike)

plot(st_geometry(schools))
plot(st_geometry(crime))
plot(st_geometry(bike))
```

**Questions to answer:**
- What dataset did you choose and why?
I choose schools, bike network and crime incidents to look school safety topics. 
- What is the data source and date?
All of the data are downloaded from OpenDataPhilly. Crime incidents data is 2025 and bike network and schools don't have their date included. 
- How many features does it contain?
There are 495 features for schoos, 169017 features for crime incidents, and 5225 features for bike network. 
- What CRS is it in? Did you need to transform it?
I transformed all of the data into EPSG:3365 for their CRS because it is an optimal option for Philadelphia. 
---

2. **Pose a research question**

Are school zones safe for walking/biking, or are they crime hotspots?

---

3. **Conduct spatial analysis**

Use at least TWO spatial operations to answer your research question.

```{r}
# Your spatial analysis

# Operation 1: BUFFERS

#find the buffers around school
schools_buffer <- schools %>%
  st_buffer(dist = 500)

# Count crime incidents near each school
schools_with_crime <- schools %>%
  mutate(
    crime_within_500m = lengths(st_intersects(schools_buffer, crime))
  )

# Summary statistics
cat("Crime incidents near schools:\n")
cat("Mean crimes per school:", mean(schools_with_crime$crime_within_500m), "\n")
cat("Max crimes near one school:", max(schools_with_crime$crime_within_500m), "\n")
cat("Schools with 10+ crimes nearby:", 
    sum(schools_with_crime$crime_within_500m >= 10), "\n\n")
cat("% Schools with 10+ crimes nearby:",
    (sum(schools_with_crime$crime_within_500m >= 10))/495, "\n\n")

# Operation 2: SPATIAL JOIN

# Find schools within 200m of bike infrastructure
schools_near_bikes <- schools %>%
  st_filter(st_buffer(bike, 200), .predicate = st_intersects) %>%
  mutate(has_bike_access = TRUE)
# Calculate percentage
pct_bike_access <- (nrow(schools_near_bikes) / nrow(schools)) * 100
cat("Schools with bike access:", nrow(schools_near_bikes), 
    "out of", nrow(schools), 
    "(", round(pct_bike_access, 1), "%)")

# Create map
ggplot() +
  geom_sf(data = bike, color = "green", size = 0.5, alpha = 1) +
  geom_sf(data = crime, color = "red", size = 0.000000001, alpha = 0.01) +
  geom_sf(data = schools_buffer, fill = "yellow", alpha = 0.8, color = NA) +
  geom_sf(data = schools_with_crime, 
          aes(color = crime_within_500m), 
          size = 1) +
  scale_color_viridis_c(
    name = "Crimes within 500m",
    option = "plasma"
  ) +
  labs(
    title = "School Safety Analysis: Crime Incidents and Bike Access",
    subtitle = "Yellow zones = 500m school buffers | Green lines = Bike network",
    caption = "Red points = Crime incidents"
  ) +
  theme_void()


```

**Your interpretation:**

The mean crime per school is around 60 and the max crime around school is 490 which is super high. There are 495 schools in total and 439 school has crimes over 10+ nearby. 88.7% of all school has crime nearby. 24.2% of the school has access to bike route. With the high percentage of crime present around school is not safe to bike around schools. There might be only a limited number of schools has the level of safety to allow students to bike around schools. 


## Finally - A few comments about your incorporation of feedback!

Remove extra instruction text and only leave what is important and present the assignment like a presentation. No need to keep the instructions. Be sure to review everything. 

---
